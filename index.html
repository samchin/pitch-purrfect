<!doctype html>
<html lang="en">
<head>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css"
          integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Interval Game</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-Zenh87qX5JnK2Jl0vWa8Ck2rdkQ2Bzep5IDxbcnCeuOxjzrPF/et3URy9Bv1WTRi" crossorigin="anonymous">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.1/jquery.min.js"
            integrity="sha512-aVKKRRi/Q/YV+4mjoKBsE4x3H+BkegoM/em46NNlCqNTmUYADjBbeNefNxYV7giUp0VxICtqdrbqU7iVaeZNXA=="
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-OERcA2EqjJCMA+/3y+gxIOqMEjwtxJY7qPCqsdltbNJuaOe923+mo//f6V8Qbsw3"
            crossorigin="anonymous"></script>
</head>
<script src="./ble_library.js"></script>

<div>
    <dialog id="startingDialog"
            style="width: 100% !important; height: 100% !important; z-index: 200; border-color: white;">
        <button id="startGame" style="width: 100% !important; height: 100% !important;" onclick="setTraining()"
                class="btn btn-secondary btn-sm"
                style="border-width: 2px"><h1>START GAME</h1></button>
    </dialog>

    <script>
        const startButton = document.getElementById("startGame");
        const dialog = document.getElementById("startingDialog");

        startButton.addEventListener("click", () => {
            bleInstance.connectionToggle();
            dialog.close("Play game");
            initializeState();
            initializeTrial();
            sendData();
        });

        dialog.showModal();


    </script>
</div>

<body>

<script>
    let stateObject = {};
    let trialObject = {};


    function initializeTrial(indexval){
        trialObject.startTime = Date.now();
        trialObject.correctNote = indexval;
        trialObject.userGuesses = Array(0);
        trialObject.guessTime = Array(0);
        trialObject.repeats = 0;
        trialObject.endTime = 0;
    }

    function updateTrial(guesses, guessTime) {
        trialObject.userGuesses.push(guesses);
        trialObject.guessTime.push(guessTime);
    }

    function endTrial(guessTime){
        trialObject.endTime = guessTime
        sendData();
    }

function initializeState(){
    stateObject.fixedC = 0;

    stateObject.audioFeedback = 0;
    stateObject.visualFeedback = 0;
    stateObject.visualInput = 0;
    stateObject.hapticInput = 0;
    stateObject.cheatInput = 0;

    stateObject.mode = "Training";

    stateObject.sustain = 0;
    stateObject.trialDelay = 1500;
    stateObject.sensoryDelay = 200;
    stateObject.intranoteDelay = 300;

    stateObject.streak = 0;

    stateObject.trialNumber = 0;
    stateObject.trialObject = trialObject;
}

function sendData() {
    console.log(JSON.stringify(stateObject))

}</script>

<div style="position: absolute; bottom: 0px; right: 0px; margin: 10px; z-index: 200; background: lightgray; padding: 14px 20px; border-radius: 8px; font-size: smaller !important;">

    <div id="manualSettings" class="d-flex flex-column mb-3">
        <div>Play Interval Manually</div>

        <div class="d-flex flex-row justify-content-between">
            <button id="1Button" onclick="playNote(0)" class="btn btn-secondary btn-sm"
                    style="border-width: 2px">1
            </button>
            <button id="2Button" onclick="playNote(1)" class="btn btn-secondary btn-sm"
                    style="border-width: 2px">2
            </button>
            <button id="3Button" onclick="playNote(2)" class="btn btn-secondary btn-sm"
                    style="border-width: 2px">3
            </button>
            <button id="4Button" onclick="playNote(3)" class="btn btn-secondary btn-sm"
                    style="border-width: 2px">4
            </button>
            <button id="5Button" onclick="playNote(4)" class="btn btn-secondary btn-sm"
                    style="border-width: 2px">5
            </button>
            <button id="6Button" onclick="playNote(5)" class="btn btn-secondary btn-sm"
                    style="border-width: 2px">6
            </button>
            <button id="7Button" onclick="playNote(6)" class="btn btn-secondary btn-sm"
                    style="border-width: 2px">7
            </button>
            <button id="8Button" onclick="playNote(7)" class="btn btn-secondary btn-sm"
                    style="border-width: 2px">8
            </button>
        </div>

        <div class="mt-2" style="width: 100%; height: 1px; background: darkgray;"></div>
    </div>


    <div id="devSettings" class="d-flex flex-column mb-3">

        <div class="d-flex flex-row justify-content-between">
            <div>0</div>
            <div style="width: 70%;" class="d-flex flex-column align-items-center">
                <input id="Sustain" type="range" min="0" max="2" step=".25" value="1" width="100%">
                <div>sustain</div>
            </div>
            <div>2</div>
        </div>

        <div class="d-flex flex-row justify-content-between">
            <br>
            <div>100 ms</div>
            <div style="width: 70%;" class="d-flex flex-column align-items-center">
                <input id="trialDelay" type="range" min="100" max="3000" step="100" value="1500" width="100%">
                <div>delay between trials</div>
            </div>
            <div>3000 ms</div>
        </div>

        <div class="d-flex flex-row justify-content-between">
            <div>0</div>
            <div style="width: 70%;" class="d-flex flex-column align-items-center">
                <input id="sensoryDelay" type="range" min="0" max="1000" step="50" value="300" width="100%">
                <div>delay between senses</div>
            </div>
            <div>1000</div>
        </div>

        <div class="d-flex flex-row justify-content-between">
            <div>500</div>
            <div style="width: 70%;" class="d-flex flex-column align-items-center">
                <input id="intranoteDelay" type="range" min="0" max="1000" step="50" value="300" width="100%">
                <div>delay between notes</div>
            </div>
            <div>5000</div>
        </div>


        <div class="mt-2 " style="width: 100%; height: 1px; background: darkgray;"></div>
        <br>
        <div style="">

            <!--            <input type="checkbox" id="visualInput" name="visualInput" value="visualInput" class="mt-2">-->
            <!--            <label for="visualInput"> Perception Game </label><br>-->
            <input type="checkbox" id="fixedC" name="fixedC" value="fixedC" class="">
            <label for="fixedC"> Fixed in C</label>
            <input type="checkbox" id="audioFeedback" name="audioFeedback" value="audioFeedback" class="">
            <label for="audioFeedback"> Audio Feedback</label>
            <input type="checkbox" id="visualFeedback" name="visualFeedback" value="visualFeedback" class="">
            <label for="visualFeedback"> Visual Feedback</label>
        </div>

        <div class="mt-2" style="width: 100%; height: 1px; background: darkgray;"></div>

        <br> <!-- Device status -->

        <div id="batteryVoltage">Waiting for battery voltage...</div>


    </div>


    <div class="d-flex flex-row">
        <button id="trainButton" onclick="setTraining()" class="btn btn-secondary btn-sm"
                style="border-width: 2px; border-color: grey;">Training
        </button>
        <button id="testButton" onclick="setTest()" class="btn btn-secondary btn-sm ml-2"
                style="border-width: 2px; border-color: grey;">Test
        </button>
        <button id="manualButton" onclick="setManual()" class="btn btn-secondary btn-sm ml-2"
                style="border-width: 2px;">Manual
        </button>
        <button id="devButton" onclick="setDev()" class="btn btn-secondary btn-sm ml-2"
                style="border-width: 2px;">Dev
        </button>
    </div>

    <script src="./states.js" type="application/javascript"></script>
</div>


<div style="position: absolute; left: 0px; bottom: 0px; margin: 10px; z-index: 200; background: lightgray; padding: 14px 20px; border-radius: 8px; font-size: smaller !important;">
    <b>Input Modalities</b>
    <div>
        <input type="checkbox" id="visualInput" name="visualInput" value="visualInput" class="mt-2">
        <label for="visualInput"> Visual Input </label><br>
        <input type="checkbox" id="hapticInput" name="hapticInput" value="hapticInput" class="">
        <label for="hapticInput"> Haptic Input </label><br>
        <input type="checkbox" id="cheatInput" name="cheatInput" value="cheatInput" class="">
        <label for="cheatInput"> Cheat Input </label><br>
    </div>



</div>

<div style="position: absolute; bottom: 0px; right: 50%; margin: 10px; z-index: 200; background: lightgray; padding: 14px 20px; border-radius: 8px; font-size: smaller !important;">
    Press Space to Repeat Note
</div>

<p id="guesses"></p>
<script>
    // $('#guesses').hide();


    $('#fixedC').change(function () {
        if (this.checked) {
            stateObject.fixedC = 1;
            baseIndex = 24;
        } else {
            fixedC = 0;
        }
    });

    $('#audioFeedback').change(function () {
        if (this.checked) {
            stateObject.audioFeedback = 1;

        } else {
            stateObject.audioFeedback = 0;
        }
    });

    $('#visualInput').change(function () {
        if (this.checked) {
            stateObject.visualInput = 1;
        } else {
            stateObject.visualInput = 0;
        }
    });

    $('#hapticInput').change(function () {
        if (this.checked) {
            stateObject.hapticInput = 1;
        } else {
            stateObject.hapticInput = 0;
        }
    });

    $('#cheatInput').change(function () {
        if (this.checked) {
            cheatSettings.hidden = false;
            stateObject.cheatInput = 1;
        } else {
            cheatSettings.hidden = true;
            stateObject.cheatInput = 0;
        }
    });
</script>

<div hidden id="cheatSettings" class="">
    <div class="d-flex justify-content-center align-items-center"
         style="position: absolute; width: 100%; height: 100%; z-index: 5">
        <h1 id="prompt"></h1>
    </div>
</div>

<div id="streakBox" class="">
    <div style="position: absolute; right: 0px; top: 0px; margin: 10px; z-index: 200; background: lightgray; padding: 14px 20px; border-radius: 8px; font-size: smaller !important;">
        Streak:
        <h4 id="streak"></h4>
    </div>
</div>

</body>


<script src="https://tonejs.github.io/build/Tone.js"></script>

<script src="./interval.js" type="application/javascript"></script>

</html>